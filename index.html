<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0b1220"/>
<link rel="manifest" href="manifest.json">
<title>出面・利益管理（複数従業員）</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f1a2e; --card:#101b30; --card2:#0f1a2e;
  --text:#e8edf7; --muted:#9db0d1; --line:#22314f;
  --accent:#f0b04a; --accent2:#3b82f6; --good:#22c55e; --bad:#ef4444;
  --radius:16px; --pad:14px;
  --cell:140px; --cellS:120px; --cellXS:100px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",system-ui,sans-serif;
  background:linear-gradient(180deg,#070c16 0%, #0b1220 35%, #0b1220 100%);
  color:var(--text);
}
header{
  position:sticky; top:0; z-index:20;
  background:rgba(11,18,32,.92); backdrop-filter: blur(10px);
  border-bottom:1px solid rgba(34,49,79,.7);
}
.wrap{max-width:1100px; margin:0 auto; padding:16px var(--pad);}
h1{margin:0 0 6px; font-size:22px; letter-spacing:.5px;}
.sub{margin:0; color:var(--muted); font-size:12px}
.toolbar{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;
}
.btn{
  appearance:none; border:1px solid var(--line); background:transparent;
  color:var(--text); padding:10px 12px; border-radius:12px; font-weight:700;
}
.btn.accent{background:var(--accent); border-color:transparent; color:#151515;}
.btn.blue{background:var(--accent2); border-color:transparent;}
.btn:active{transform:translateY(1px)}
.pill{
  border:1px solid var(--line); border-radius:14px; padding:10px 12px;
  display:flex; align-items:center; gap:8px; background:rgba(16,27,48,.55);
}
.pill label{font-size:12px; color:var(--muted)}
.pill input, .pill select{
  background:transparent; color:var(--text); border:none; outline:none; font-size:16px; min-width:110px;
}
.grid{
  display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px;
}
.card{
  background:rgba(16,27,48,.72); border:1px solid rgba(34,49,79,.7);
  border-radius:var(--radius); padding:14px;
}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.row.space{justify-content:space-between}
.small{font-size:12px; color:var(--muted)}
hr.sep{border:none; border-top:1px solid rgba(34,49,79,.7); margin:12px 0}
.employee{
  border:1px solid rgba(34,49,79,.8); border-radius:var(--radius);
  overflow:hidden; background:rgba(15,26,46,.7);
}
.employeeHeader{
  padding:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
  background:rgba(15,26,46,.9); border-bottom:1px solid rgba(34,49,79,.7);
}
.employeeHeader h2{margin:0; font-size:22px}
.seg{
  display:flex; gap:0; border:1px solid rgba(34,49,79,.85);
  border-radius:14px; overflow:hidden;
}
.seg button{
  appearance:none; border:none; padding:8px 12px; background:transparent; color:var(--muted);
  font-weight:800; min-width:88px;
}
.seg button.on{background:rgba(240,176,74,.18); color:var(--text)}
.seg button + button{border-left:1px solid rgba(34,49,79,.75)}
.kv{display:grid; grid-template-columns:1fr 180px; gap:10px; align-items:center}
.kv label{font-size:12px; color:var(--muted)}
.kv input{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(34,49,79,.8);
  background:rgba(11,18,32,.35); color:var(--text); font-size:16px; outline:none;
}
.tableWrap{padding:14px}
.hscroll{
  width:100%;
  overflow:auto;
  border-radius:14px;
  border:1px solid rgba(34,49,79,.75);
  background:rgba(11,18,32,.35);
}
table{
  border-collapse:separate; border-spacing:0; width:max-content; min-width:100%;
  font-variant-numeric: tabular-nums;
}
th,td{
  border-bottom:1px solid rgba(34,49,79,.7);
  padding:10px 10px;
  min-width:var(--cell);
  text-align:right;
}
th{position:sticky; top:0; z-index:5; background:rgba(11,18,32,.92); color:var(--muted); font-size:12px; text-transform:none}
td{background:transparent}
td.left, th.left{text-align:left}
td.center, th.center{text-align:center}
td.sticky, th.sticky{position:sticky; left:0; z-index:4; background:rgba(11,18,32,.92)}
td.sticky2, th.sticky2{position:sticky; left:var(--cellXS); z-index:4; background:rgba(11,18,32,.92)}
td.sticky3, th.sticky3{position:sticky; left:calc(var(--cellXS) + var(--cellS)); z-index:4; background:rgba(11,18,32,.92)}
th.sticky{z-index:6}
input.cell, select.cell{
  width:100%; padding:8px 10px; border-radius:10px;
  border:1px solid rgba(34,49,79,.8); background:rgba(15,26,46,.7); color:var(--text);
  font-size:15px; outline:none; text-align:right;
}
td .miniBtn{
  border:1px solid rgba(34,49,79,.8); background:rgba(15,26,46,.65);
  color:var(--text); border-radius:10px; padding:8px 10px; font-weight:800;
}
td .miniBtn.danger{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35)}
.money.good{color:var(--good); font-weight:900}
.money.bad{color:var(--bad); font-weight:900}
.money.accent{color:var(--accent); font-weight:900}
tfoot td{background:rgba(15,26,46,.7); font-weight:900}
.footerTotals{
  display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px;
}
.totalBox{
  border:1px solid rgba(34,49,79,.7); border-radius:14px; padding:12px;
  background:rgba(11,18,32,.35);
}
.totalBox .k{color:var(--muted); font-size:12px}
.totalBox .v{font-size:18px; font-weight:900; margin-top:6px}
.totalBox .v.good{color:var(--good)} .totalBox .v.bad{color:var(--bad)} .totalBox .v.accent{color:var(--accent)}
/* Payslip modal */
.modal{
  position:fixed; inset:0; z-index:50;
  background:rgba(0,0,0,.6); display:none; align-items:flex-start; justify-content:center;
  padding:18px 12px;
}
.modal.on{display:flex}
.sheet{
  width:min(720px,100%); background:#fff; color:#111; border-radius:16px; overflow:hidden;
}
.sheetHead{
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 14px; background:#f5f6f9; border-bottom:1px solid #e5e7eb;
}
.sheetHead .title{font-weight:900}
.sheetHead .actions{display:flex; gap:8px}
.sheetHead button{border:1px solid #d1d5db; background:#fff; border-radius:10px; padding:8px 10px; font-weight:800}
.sheetBody{padding:18px 18px 22px}
.sheetBody h3{margin:0; text-align:center; font-size:28px; letter-spacing:1px}
.sheetBody .period{text-align:center; margin-top:8px; color:#374151; font-weight:700}
.sheetBody .bar{height:3px; background:#111827; margin:16px 0}
.sheetTopRow{display:flex; justify-content:space-between; align-items:flex-end; gap:10px}
.sheetTopRow .name{font-size:26px; font-weight:900}
.sheetTopRow .sum{font-size:30px; font-weight:900}
.tbl{
  width:100%; border-collapse:collapse; margin-top:12px;
}
.tbl th,.tbl td{border:1px solid #111827; padding:10px; font-size:16px}
.tbl th{background:#f3f4f6; text-align:left}
.tbl td:last-child{text-align:right; font-variant-numeric: tabular-nums}
.tbl .right{text-align:right}
.bigNet{display:flex; justify-content:space-between; align-items:flex-end; margin-top:14px}
.bigNet .label{font-size:24px; font-weight:900}
.bigNet .net{font-size:44px; font-weight:900}
@media print{
  body{background:#fff}
  header,.wrap>.card,.employeeHeader .seg,.employeeHeader .btn,.toolbar,.small,.modal .actions{display:none !important}
  .modal{position:static; inset:auto; display:block !important; background:transparent; padding:0}
  .sheet{border-radius:0; box-shadow:none; width:100%}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>出面・利益管理（複数従業員）</h1>
    <p class="sub">1日1行で入力 → 月合計を自動集計（端末内で保存 / オフラインOK）</p>
    <div class="toolbar">
      <div class="pill">
        <label>対象月</label>
        <select id="monthSel"></select>
      </div>
      <button class="btn accent" id="addTodayBtn">今日を追加</button>
      <button class="btn" id="addRowBtn">行追加</button>
      <button class="btn" id="csvBtn">CSV</button>
      <button class="btn blue" id="allPayslipBtn">給与明細（全員）</button>
      <button class="btn" id="resetBtn" title="端末内データを初期化">リセット</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row space">
      <div style="font-weight:900; font-size:16px">従業員</div>
      <div class="row">
        <div class="pill">
          <label>従業員名</label>
          <input id="newEmpName" placeholder="名前" />
        </div>
        <button class="btn" id="addEmpBtn">追加</button>
      </div>
    </div>
    <p class="small" style="margin:10px 0 0">
      ※雇用保険：本人 0.7% / 会社 1.15%（四捨五入）　※受取税：売上の10%（四捨五入）　※粗利控除：給与の10%（四捨五入）＋会社負担雇用保険
    </p>
  </div>

  <div id="empList" class="grid"></div>
</div>

<!-- Payslip Modal -->
<div class="modal" id="payslipModal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="sheetHead">
      <div class="title" id="sheetTitle">給与明細プレビュー</div>
      <div class="actions">
        <button id="printBtn">印刷 / 保存</button>
        <button id="closeSheetBtn">閉じる</button>
      </div>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </div>
</div>

<script>
/*** Utilities ***/
const round = (n)=> Math.round((Number(n)||0));
const yen = (n)=> (round(n)).toLocaleString('ja-JP');
const pad2 = (n)=> String(n).padStart(2,'0');
const ymKey = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
const parseYM = (s)=> {
  const [y,m]=s.split('-').map(Number);
  return {y, m};
};
const daysInMonth = (y,m)=> new Date(y,m,0).getDate();
const isoDate = (y,m,d)=> `${y}-${pad2(m)}-${pad2(d)}`;
const jpDate = (iso)=> {
  const [y,m,d]=iso.split('-').map(Number);
  return `${y}/${pad2(m)}/${pad2(d)}`;
};
const jpDow = (iso)=>{
  const dt = new Date(iso + "T00:00:00");
  const w = ["日","月","火","水","木","金","土"][dt.getDay()];
  return w;
};
const uid = ()=> Math.random().toString(36).slice(2,10);

/*** Business constants ***/
const SALES_PER_PERSON = 16000;
const SALES_OVERTIME_UNIT = 2500; // 売上の残業（1時間）
const OVERTIME_WAGE_DEFAULT = 2031;
const EI_EMP_RATE = 0.007;   // 本人負担
const EI_CO_RATE  = 0.0115;  // 会社負担
const RECEIVED_VAT_RATE = 0.10;
const GROSS_DEDUCT_RATE = 0.10; // 給与10%

/*** Storage ***/
const LS_KEY = "deme_app_v3";
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function defaultState(){
  const now = new Date();
  const ym = ymKey(now);
  return {
    version: 3,
    months: [ym],
    currentMonth: ym,
    employees: [
      // {id, name, wageA, wageB, defaultWageKey, overtimeRate}
      {id: uid(), name:"濱村拓也", wageA:10500, wageB:13000, defaultWageKey:"A", overtimeRate:2031},
      {id: uid(), name:"（例）", wageA:13000, wageB:13000, defaultWageKey:"A", overtimeRate:2031},
    ],
    // entries[month][empId] = [{id, date, people, otH, wageKey, advance, incomeTax}]
    entries: {}
  };
}

let state = loadState() || defaultState();

/*** Ensure structures ***/
function ensureMonth(ym){
  if(!state.months.includes(ym)) state.months.unshift(ym);
  if(!state.entries[ym]) state.entries[ym] = {};
  for(const emp of state.employees){
    if(!state.entries[ym][emp.id]) state.entries[ym][emp.id] = [];
  }
}
ensureMonth(state.currentMonth);

/*** Month selector ***/
const monthSel = document.getElementById("monthSel");
function refreshMonthSel(){
  monthSel.innerHTML = "";
  for(const ym of state.months){
    const opt = document.createElement("option");
    opt.value = ym; opt.textContent = ym;
    if(ym === state.currentMonth) opt.selected = true;
    monthSel.appendChild(opt);
  }
}
monthSel.addEventListener("change", ()=>{
  state.currentMonth = monthSel.value;
  ensureMonth(state.currentMonth);
  saveState();
  render();
});

/*** Buttons ***/
document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(!confirm("端末内データを全削除します。よろしいですか？")) return;
  localStorage.removeItem(LS_KEY);
  state = defaultState();
  ensureMonth(state.currentMonth);
  refreshMonthSel();
  render();
});
document.getElementById("addTodayBtn").addEventListener("click", ()=>{
  addTodayAll();
});
document.getElementById("addRowBtn").addEventListener("click", ()=>{
  addBlankRowAll();
});
document.getElementById("addEmpBtn").addEventListener("click", ()=>{
  const name = (document.getElementById("newEmpName").value||"").trim();
  if(!name) return;
  state.employees.unshift({id: uid(), name, wageA:13000, wageB:13000, defaultWageKey:"A", overtimeRate:OVERTIME_WAGE_DEFAULT});
  ensureMonth(state.currentMonth);
  document.getElementById("newEmpName").value = "";
  saveState();
  render();
});
document.getElementById("csvBtn").addEventListener("click", ()=>{
  downloadCSV();
});
document.getElementById("allPayslipBtn").addEventListener("click", ()=>{
  openPayslip("ALL");
});

/*** Row operations (no confirmation) ***/
function addTodayAll(){
  const today = new Date();
  const ym = state.currentMonth;
  const {y,m} = parseYM(ym);
  // その月以外なら対象月の1日を追加
  const d = (today.getFullYear()===y && (today.getMonth()+1)===m) ? today.getDate() : 1;
  const iso = isoDate(y,m,d);
  for(const emp of state.employees){
    const list = state.entries[ym][emp.id] || [];
    if(list.some(r=>r.date===iso)) continue; // already exists
    list.unshift({id: uid(), date: iso, people:1, otH:0, wageKey: emp.defaultWageKey || "A", advance:0, incomeTax:0});
    state.entries[ym][emp.id] = list;
  }
  saveState();
  render();
}
function addBlankRowAll(){
  const ym = state.currentMonth;
  const {y,m} = parseYM(ym);
  const iso = isoDate(y,m,1);
  for(const emp of state.employees){
    const list = state.entries[ym][emp.id] || [];
    list.unshift({id: uid(), date: iso, people:0, otH:0, wageKey: emp.defaultWageKey || "A", advance:0, incomeTax:0});
    state.entries[ym][emp.id] = list;
  }
  saveState();
  render();
}

/*** Calculations ***/
function wageFor(emp, wageKey){
  const k = wageKey || emp.defaultWageKey || "A";
  return (k==="B") ? (Number(emp.wageB)||0) : (Number(emp.wageA)||0);
}
function calcRow(emp, row){
  const people = Number(row.people)||0;
  const otH = Number(row.otH)||0;
  const wage = wageFor(emp, row.wageKey);
  const overtimeRate = Number(emp.overtimeRate)||0;

  const sales = round(people*SALES_PER_PERSON + otH*SALES_OVERTIME_UNIT);
  const basePay = round(people*wage);
  const otPay = round(otH*overtimeRate);
  const payTotal = round(basePay + otPay);

  const eiEmp = round(payTotal * EI_EMP_RATE);
  const eiCo  = round(payTotal * EI_CO_RATE);

  const receivedVat = round(sales * RECEIVED_VAT_RATE);
  const grossDeduct = round(payTotal * GROSS_DEDUCT_RATE);

  const incomeTax = round(row.incomeTax||0);
  const advance = round(row.advance||0);

  const takeHome = round(payTotal - eiEmp - incomeTax - advance);

  const gross = round(sales - payTotal - grossDeduct - eiCo);

  return {people, otH, sales, basePay, otPay, payTotal, eiEmp, eiCo, receivedVat, grossDeduct, incomeTax, advance, takeHome, gross};
}
function calcMonthEmp(emp, ym){
  const list = (state.entries[ym] && state.entries[ym][emp.id]) ? state.entries[ym][emp.id] : [];
  const sums = {
    days:0, otH:0, sales:0, basePay:0, otPay:0, payTotal:0, eiEmp:0, eiCo:0, receivedVat:0, grossDeduct:0, incomeTax:0, advance:0, takeHome:0, gross:0
  };
  for(const row of list){
    const c = calcRow(emp,row);
    const worked = (c.people>0 || c.payTotal>0 || c.sales>0);
    if(worked) sums.days += 1;
    sums.otH += c.otH;
    sums.sales += c.sales;
    sums.basePay += c.basePay;
    sums.otPay += c.otPay;
    sums.payTotal += c.payTotal;
    sums.eiEmp += c.eiEmp;
    sums.eiCo += c.eiCo;
    sums.receivedVat += c.receivedVat;
    sums.grossDeduct += c.grossDeduct;
    sums.incomeTax += c.incomeTax;
    sums.advance += c.advance;
    sums.takeHome += c.takeHome;
    sums.gross += c.gross;
  }
  // round aggregated too (for safety)
  for(const k in sums) sums[k] = round(sums[k]);
  return {list, sums};
}
function calcMonthAll(ym){
  const total = {
    days:0, otH:0, sales:0, basePay:0, otPay:0, payTotal:0, eiEmp:0, eiCo:0, receivedVat:0, grossDeduct:0, incomeTax:0, advance:0, takeHome:0, gross:0
  };
  for(const emp of state.employees){
    const {sums} = calcMonthEmp(emp,ym);
    for(const k in total) total[k] += sums[k];
  }
  for(const k in total) total[k] = round(total[k]);
  return total;
}

/*** Rendering ***/
const empList = document.getElementById("empList");

function render(){
  ensureMonth(state.currentMonth);
  refreshMonthSel();
  empList.innerHTML = "";

  const ym = state.currentMonth;
  const {y,m} = parseYM(ym);

  // make sure entries exist
  for(const emp of state.employees){
    if(!state.entries[ym][emp.id]) state.entries[ym][emp.id] = [];
  }

  // employees
  for(const emp of state.employees){
    const wrap = document.createElement("div");
    wrap.className="employee";

    const head = document.createElement("div");
    head.className="employeeHeader";

    const left = document.createElement("div");
    left.style.display="flex";
    left.style.gap="12px";
    left.style.alignItems="center";
    left.style.flexWrap="wrap";
    const h2 = document.createElement("h2");
    h2.textContent = emp.name;
    left.appendChild(h2);

    const seg = document.createElement("div");
    seg.className="seg";
    const btnA = document.createElement("button");
    btnA.textContent = "¥" + yen(emp.wageA||0);
    btnA.className = (emp.defaultWageKey==="A") ? "on" : "";
    btnA.onclick = ()=>{ emp.defaultWageKey="A"; saveState(); render(); };
    const btnB = document.createElement("button");
    btnB.textContent = "¥" + yen(emp.wageB||0);
    btnB.className = (emp.defaultWageKey==="B") ? "on" : "";
    btnB.onclick = ()=>{ emp.defaultWageKey="B"; saveState(); render(); };
    seg.appendChild(btnA); seg.appendChild(btnB);

    left.appendChild(seg);

    const right = document.createElement("div");
    right.className="row";
    const payslipBtn = document.createElement("button");
    payslipBtn.className="btn blue";
    payslipBtn.textContent="給与明細";
    payslipBtn.onclick = ()=> openPayslip(emp.id);
    const delEmpBtn = document.createElement("button");
    delEmpBtn.className="btn";
    delEmpBtn.textContent="削除";
    delEmpBtn.onclick = ()=>{
      if(!confirm(emp.name+" を削除します。よろしいですか？")) return;
      state.employees = state.employees.filter(e=>e.id!==emp.id);
      if(state.entries[ym]) delete state.entries[ym][emp.id];
      saveState();
      render();
    };
    right.appendChild(payslipBtn);
    right.appendChild(delEmpBtn);

    head.appendChild(left);
    head.appendChild(right);

    // settings line
    const settings = document.createElement("div");
    settings.className="tableWrap";
    settings.style.paddingTop="0";
    settings.innerHTML = `
      <div class="row" style="gap:12px; flex-wrap:wrap">
        <div class="kv" style="width:260px">
          <label>日当 A（円）</label>
          <input inputmode="numeric" value="${emp.wageA||0}" data-k="wageA">
        </div>
        <div class="kv" style="width:260px">
          <label>日当 B（円）</label>
          <input inputmode="numeric" value="${emp.wageB||0}" data-k="wageB">
        </div>
        <div class="kv" style="width:260px">
          <label>残業時給（円）</label>
          <input inputmode="numeric" value="${emp.overtimeRate||OVERTIME_WAGE_DEFAULT}" data-k="overtimeRate">
        </div>
      </div>
    `;
    settings.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("change", ()=>{
        const k = inp.getAttribute("data-k");
        emp[k] = round(inp.value);
        saveState();
        render();
      });
    });

    // table
    const tableWrap = document.createElement("div");
    tableWrap.className="tableWrap";
    const {list, sums} = calcMonthEmp(emp, ym);

    tableWrap.innerHTML = `
      <div class="hscroll">
        <table>
          <thead>
            <tr>
              <th class="sticky left" style="min-width:var(--cellXS)">日付</th>
              <th class="sticky2 center" style="min-width:var(--cellS)">人工</th>
              <th class="sticky3 center" style="min-width:var(--cellS)">残業(量)</th>
              <th class="center" style="min-width:var(--cellS)">日当</th>
              <th>前払給与</th>
              <th>所得税</th>
              <th>売上</th>
              <th>受取税</th>
              <th>基本給</th>
              <th>残業給</th>
              <th class="money accent">総支給</th>
              <th>雇用保険(本人0.7%)</th>
              <th>雇用保険(会社1.15%)</th>
              <th>粗利控除(給与10%)</th>
              <th class="money good">粗利</th>
              <th class="center">操作</th>
            </tr>
          </thead>
          <tbody id="tbody-${emp.id}"></tbody>
          <tfoot>
            <tr>
              <td class="sticky left">月合計</td>
              <td class="sticky2 center">${yen(sums.days)}</td>
              <td class="sticky3 center">${yen(sums.otH)}</td>
              <td class="center">-</td>
              <td>${yen(sums.advance)}</td>
              <td>${yen(sums.incomeTax)}</td>
              <td>${yen(sums.sales)}</td>
              <td>${yen(sums.receivedVat)}</td>
              <td>${yen(sums.basePay)}</td>
              <td>${yen(sums.otPay)}</td>
              <td class="money accent">${yen(sums.payTotal)}</td>
              <td>${yen(sums.eiEmp)}</td>
              <td>${yen(sums.eiCo)}</td>
              <td>${yen(sums.grossDeduct)}</td>
              <td class="money good">${yen(sums.gross)}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="footerTotals">
        <div class="totalBox">
          <div class="k">月間 売上</div>
          <div class="v">${yen(sums.sales)}</div>
        </div>
        <div class="totalBox">
          <div class="k">月間 控除計（本人雇用保険+所得税+前払）</div>
          <div class="v bad">-${yen(sums.eiEmp + sums.incomeTax + sums.advance)}</div>
        </div>
        <div class="totalBox">
          <div class="k">月間 粗利（会社負担含め控除）</div>
          <div class="v good">${yen(sums.gross)}</div>
        </div>
      </div>
    `;

    // fill body rows
    const tbody = tableWrap.querySelector(`#tbody-${emp.id}`);
    if(list.length===0){
      // init with all days of month
      const n = daysInMonth(y,m);
      const rows = [];
      for(let d=1; d<=n; d++){
        rows.push({id: uid(), date: isoDate(y,m,d), people:0, otH:0, wageKey: emp.defaultWageKey||"A", advance:0, incomeTax:0});
      }
      state.entries[ym][emp.id] = rows;
      saveState();
      return render(); // rerender
    }
    // sort by date asc
    list.sort((a,b)=> a.date.localeCompare(b.date));
    for(const row of list){
      const c = calcRow(emp,row);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="sticky left" style="min-width:var(--cellXS)">${jpDate(row.date)} <span class="small">(${jpDow(row.date)})</span></td>
        <td class="sticky2 center" style="min-width:var(--cellS)"><input class="cell" inputmode="numeric" data-f="people" value="${row.people??0}"></td>
        <td class="sticky3 center" style="min-width:var(--cellS)"><input class="cell" inputmode="numeric" data-f="otH" value="${row.otH??0}"></td>
        <td class="center" style="min-width:var(--cellS)">
          <select class="cell" data-f="wageKey">
            <option value="A" ${row.wageKey==="A"?"selected":""}>¥${yen(emp.wageA||0)}</option>
            <option value="B" ${row.wageKey==="B"?"selected":""}>¥${yen(emp.wageB||0)}</option>
          </select>
        </td>
        <td><input class="cell" inputmode="numeric" data-f="advance" value="${row.advance??0}"></td>
        <td><input class="cell" inputmode="numeric" data-f="incomeTax" value="${row.incomeTax??0}"></td>
        <td>${yen(c.sales)}</td>
        <td class="money good">${yen(c.receivedVat)}</td>
        <td>${yen(c.basePay)}</td>
        <td>${yen(c.otPay)}</td>
        <td class="money accent">${yen(c.payTotal)}</td>
        <td>${yen(c.eiEmp)}</td>
        <td>${yen(c.eiCo)}</td>
        <td>${yen(c.grossDeduct)}</td>
        <td class="money good">${yen(c.gross)}</td>
        <td class="center">
          <button class="miniBtn" data-act="dup">複製</button>
          <button class="miniBtn danger" data-act="del">削除</button>
        </td>
      `;
      tr.querySelectorAll("input,select").forEach(el=>{
        el.addEventListener("change", ()=>{
          const f = el.getAttribute("data-f");
          if(f==="wageKey"){
            row.wageKey = el.value;
          }else{
            row[f] = round(el.value);
          }
          saveState();
          render();
        });
      });
      tr.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          if(act==="del"){
            // no confirmation (as requested)
            state.entries[ym][emp.id] = state.entries[ym][emp.id].filter(r=>r.id!==row.id);
          }else if(act==="dup"){
            const copy = {...row, id: uid()};
            state.entries[ym][emp.id].push(copy);
          }
          saveState();
          render();
        });
      });
      tbody.appendChild(tr);
    }

    wrap.appendChild(head);
    wrap.appendChild(settings);
    wrap.appendChild(tableWrap);
    empList.appendChild(wrap);
  }

  // overall monthly totals card
  const all = calcMonthAll(ym);
  const allCard = document.createElement("div");
  allCard.className="card";
  allCard.innerHTML = `
    <div style="font-weight:900; font-size:16px; margin-bottom:10px">月毎の集計（合計） ${ym}</div>
    <div class="footerTotals" style="grid-template-columns:repeat(4,1fr)">
      <div class="totalBox"><div class="k">売上 合計</div><div class="v">${yen(all.sales)}</div></div>
      <div class="totalBox"><div class="k">総支給 合計</div><div class="v accent">${yen(all.payTotal)}</div></div>
      <div class="totalBox"><div class="k">雇用保険（会社）合計</div><div class="v">${yen(all.eiCo)}</div></div>
      <div class="totalBox"><div class="k">粗利 合計</div><div class="v good">${yen(all.gross)}</div></div>
    </div>
    <p class="small" style="margin:10px 0 0">※粗利は「売上 − 総支給 − 粗利控除(給与10%) − 雇用保険(会社1.15%)」で計算</p>
  `;
  empList.prepend(allCard);
}

/*** Payslip ***/
const modal = document.getElementById("payslipModal");
const sheetBody = document.getElementById("sheetBody");
const sheetTitle = document.getElementById("sheetTitle");
document.getElementById("closeSheetBtn").addEventListener("click", closePayslip);
document.getElementById("printBtn").addEventListener("click", ()=> window.print());
modal.addEventListener("click", (e)=>{ if(e.target===modal) closePayslip(); });

function openPayslip(empIdOrAll){
  const ym = state.currentMonth;
  const {y,m} = parseYM(ym);

  if(empIdOrAll==="ALL"){
    sheetTitle.textContent = "給与明細プレビュー（全員）";
    const all = calcMonthAll(ym);
    sheetBody.innerHTML = buildPayslipHTML({
      name:"全員 合計",
      period:`${y}年${m}月分`,
      sums: all,
      showDeductions: true,
      incomeTax: all.incomeTax,
      advance: all.advance
    });
  }else{
    const emp = state.employees.find(e=>e.id===empIdOrAll);
    if(!emp) return;
    sheetTitle.textContent = `給与明細プレビュー（${emp.name}）`;
    const {sums} = calcMonthEmp(emp, ym);
    sheetBody.innerHTML = buildPayslipHTML({
      name: emp.name + " 様",
      period:`${y}年${m}月分`,
      sums,
      showDeductions: true,
      incomeTax: sums.incomeTax,
      advance: sums.advance
    });
  }
  modal.classList.add("on");
  modal.setAttribute("aria-hidden","false");
}
function closePayslip(){
  modal.classList.remove("on");
  modal.setAttribute("aria-hidden","true");
}
function buildPayslipHTML({name, period, sums}){
  const payTotal = sums.payTotal;
  const deductions = round(sums.eiEmp + sums.incomeTax + sums.advance);
  const net = round(payTotal - deductions);
  return `
    <h3>給与明細書</h3>
    <div class="period">${period}</div>
    <div class="bar"></div>

    <div class="sheetTopRow">
      <div class="name">${name}</div>
      <div style="text-align:right">
        <div style="color:#6b7280; font-weight:800">支給合計</div>
        <div class="sum">¥${yen(payTotal)}</div>
      </div>
    </div>

    <table class="tbl" style="margin-top:14px">
      <tr><th>支給項目</th><th class="right">金額 / 詳細</th></tr>
      <tr><td>出勤日数</td><td>${yen(sums.days)} 日</td></tr>
      <tr><td>残業時間（合計）</td><td>${yen(sums.otH)} H</td></tr>
      <tr><td>基本給（日当計）</td><td>¥${yen(sums.basePay)}</td></tr>
      <tr><td>残業手当</td><td>¥${yen(sums.otPay)}</td></tr>
      <tr><td><b>総支給額</b></td><td><b>¥${yen(payTotal)}</b></td></tr>
    </table>

    <table class="tbl" style="margin-top:14px">
      <tr><th>控除項目</th><th class="right">金額</th></tr>
      <tr><td>雇用保険料（本人0.7%）</td><td style="color:#b91c1c; font-weight:900">▲ ${yen(sums.eiEmp)}</td></tr>
      <tr><td>所得税</td><td style="color:#b91c1c; font-weight:900">▲ ${yen(sums.incomeTax)}</td></tr>
      <tr><td>前払金</td><td style="color:#b91c1c; font-weight:900">▲ ${yen(sums.advance)}</td></tr>
      <tr><td><b>控除合計</b></td><td style="color:#b91c1c; font-weight:900"><b>▲ ${yen(deductions)}</b></td></tr>
    </table>

    <div class="bar"></div>
    <div class="bigNet">
      <div class="label">差引支給額（手取り）</div>
      <div class="net">¥${yen(net)}</div>
    </div>

    <div style="margin-top:10px; color:#6b7280; font-size:12px; font-weight:700">
      参考：雇用保険（会社負担1.15%） ¥${yen(sums.eiCo)} / 受取税（売上10%） ¥${yen(sums.receivedVat)} / 粗利控除（給与10%） ¥${yen(sums.grossDeduct)}
    </div>
  `;
}

/*** CSV export ***/
function downloadCSV(){
  const ym = state.currentMonth;
  const rows = [];
  rows.push([
    "月","従業員","日付","人工","残業時間","日当","前払給与","所得税",
    "売上","受取税","基本給","残業給","総支給","雇用保険(本人)","雇用保険(会社)","粗利控除(給与10%)","粗利","手取り"
  ].join(","));

  for(const emp of state.employees){
    const list = (state.entries[ym] && state.entries[ym][emp.id]) ? state.entries[ym][emp.id] : [];
    const sorted = [...list].sort((a,b)=>a.date.localeCompare(b.date));
    for(const r of sorted){
      const c = calcRow(emp,r);
      rows.push([
        ym, emp.name, r.date, c.people, c.otH, wageFor(emp,r.wageKey),
        c.advance, c.incomeTax, c.sales, c.receivedVat, c.basePay, c.otPay, c.payTotal, c.eiEmp, c.eiCo, c.grossDeduct, c.gross, c.takeHome
      ].join(","));
    }
  }
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download = `deme_${ym}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
}

/*** PWA ***/
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

/*** init ***/
refreshMonthSel();
render();
</script>
</body>
</html>
